# システム全体像

## RaspberryPiServer (Pi5)
- 旧 Window A が担っていたサーバー処理をすべて引き受ける中枢。
- `/api/v1/scans` や `/api/logistics/jobs` をはじめとする REST API、Socket.IO イベント、PostgreSQL への書き込み、DocumentViewer UI 配信、USB 配布・バックアップを統合して管理。
- 現在の再構築では Flask ベースの雛形と `/api/v1/scans` の Blueprint プレースホルダーを作成済みで、段階的に既存ロジックを移設する。
- リポジトリ層は `SCAN_REPOSITORY_BACKEND` で切替可能とし、現状は `memory` が既定、`db` を指定すると PostgreSQL 用プレースホルダーが初期化される。
- Pi Zero 2 W からのスキャンを唯一の受信点とし、Pi4 へは Socket.IO などで状態をブロードキャストする。

## Window A (Pi4)
- ユーザーが実際に操作する UI と周辺機器（NFC リーダー、USB ハンディリーダー）の集約点。
- Pi5 の DocumentViewer iframe を埋め込み、`dv-barcode` 通知を所在一覧の強調表示に接続。
- 全トランザクションは Pi5 の API にプロキシし、Pi4 側には表示とデバイス制御のみを残す。

## Pi Zero 2 W
- ハンディ端末として Wi-Fi 経由で Pi5 の `/api/v1/scans` にスキャン結果を送信。
- Pi5 からの Socket.IO ブロードキャストにより Pi4 UI の所在一覧や構内物流タブへ反映。
- `mirrorctl` による 14 日連続監視の対象であり、Pi5 と合わせて可用性を確保する。

## 三層構造の狙い
- Pi5 は「状態とデータ」の集約点、Pi4 は「ユーザー操作と周辺デバイス」の集約点、Pi Zero は「現場スキャン入力」の集約点とし、役割分担を明確にする。
- 今後のモジュール化は Pi4 から Pi5 へロジックを段階的に移行しつつ、現場のスキャン体験（NFC / ハンディ / Wi-Fi）を途切れさせないことを最優先とする。

## 開発指針（再構築時の注意点）
- 既存リポジトリの正常動作していたコードは積極的に流用し、モジュール単位で再利用しやすい形に再構成する。
- モジュール境界や責務を明確にし、拡張性・保守性を最優先して設計する（Pi5 API、クライアント UI、ハンディ送信、USB フローなどを独立して差し替え可能にする）。
- 自動テストは少なくとも 1 回は成功している履歴があるが、2 回目のテスト準備時に環境が破損して再開発を強いられた経緯があるため、再構築後はテスト環境の再現性と復旧手順を文書化し、再発防止に努める。
- 作業の順序に固定の優先度はなく、進行が最も順調に進められるモジュールから着手する方針とする。個々のタスクは状況に応じて柔軟に入れ替える。
- Pi5 の REST / Socket.IO API 仕様は RaspberryPiServer リポジトリ内ドキュメントを参照する想定だが、現時点では該当ファイルの所在が未確認であり、調査の上で本リポジトリの設計ドキュメントへ要約するタスクが必要。
- 復旧対象の運用シナリオも事前に固定せず、開発の成功確率が最も高いフローから順に整備する。たとえばハンディ→Pi5→UI 更新の流れを検討する場合も、状況に応じて別フローを先行する。
- 自動テスト環境の再構築は見送る方向とし、代わりに本リポジトリでテストメニュー（手動確認手順）を整備してオーナーが実行できる形にする。
- テストメニューは一時的利用ではなく、保守や構造理解に資する資産として整備する。将来の開発者が参照しやすいよう、チェックリストやフロー図を含めた常設ドキュメントとして残す。
- 手動テストの中心は開発難易度とロジック複雑度が最も高いフロー（例: Pi Zero → Pi5 → Window A/DocumentViewer 連携）から構築し、そこを基点に他フローへ展開する。

## 参照リポジトリと主な場所
- Window A: `/Users/tsudatakashi/tool-management-system02`
- DocumentViewer: `/Users/tsudatakashi/DocumentViewer`
- RaspberryPizero2W_withDropbox: `/Users/tsudatakashi/RaspberryPizero2W_withDropbox`
- OnSiteLogistics: `/Users/tsudatakashi/OnSiteLogistics`
- RaspberryPiServer: `/Users/tsudatakashi/RaspberryPiServer`

## リポジトリ構成の方針
- 旧開発では機能ごとにリポジトリを分割していたが、本再構築では単一リポジトリに統合する。モジュールごとのディレクトリを切り分け、責務やテストメニューを文書化して整合性を保つ。
- 単一リポジトリ化により、API/クライアント/ハンディ/サイネージ/USB フローを一括で追跡しやすくし、変更の影響範囲を共有ドキュメントで管理する。必要に応じてビルド・デプロイ単位でサブディレクトリやパッケージ管理を導入する。
- 現時点では `server/`（Pi5 サーバー）、`client_window_a/`（Pi4 クライアント）、`handheld/`（Pi Zero）、`docs/`（設計・テスト）を基礎とする構造を採用している。
- 中長期のタスクは `docs/system/next-steps.md` に整理し、モジュール横断の作業状況を共有する。
- Pi5 向け設定は `server/config/` に集約し、TOML 形式で環境ごとの差分を管理できるようにする（`default.toml` を基本とし、`RPI_SERVER_CONFIG` 環境変数で切り替え）。

必要に応じて上記リポジトリから設計資料や実装例を参照するが、このリポジトリでは新規設計・実装を行う。
