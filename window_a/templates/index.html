<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>Window A Dashboard</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 0;
        background: #f4f6f8;
        color: #1f2933;
      }
      header {
        background: #0f6ab4;
        color: white;
        padding: 1.5rem;
      }
      header h1 {
        margin: 0;
      }
      main {
        padding: 1.5rem;
      }
      section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
      }
      h2 {
        margin-top: 0;
        font-size: 1.2rem;
        color: #0f4a87;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }
      th,
      td {
        padding: 0.5rem;
        border-bottom: 1px solid #e1e7ef;
        text-align: left;
      }
      th {
        background: #f0f3f8;
        font-weight: 600;
      }
      .status-ok {
        color: #0f8a3c;
        font-weight: bold;
      }
      .status-fail {
        color: #c0392b;
        font-weight: bold;
      }
      .helper-text {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 0.25rem;
      }
      iframe {
        width: 100%;
        min-height: 360px;
        border: 1px solid #d0d7e3;
        border-radius: 6px;
      }
      pre {
        background: #f8fafc;
        padding: 0.75rem;
        border-radius: 6px;
        overflow-x: auto;
      }
      .toolmgmt-log {
        background: #f8fafc;
        border: 1px solid #d0d7e3;
        border-radius: 6px;
        padding: 0.75rem;
        max-height: 220px;
        overflow-y: auto;
        font-size: 0.85rem;
      }
      .toolmgmt-log ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }
      .toolmgmt-log li {
        margin-bottom: 0.35rem;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Window A Dashboard</h1>
      <p>
        DocumentViewer:
        {% if doc_viewer_online %}
          <span class="status-ok">ONLINE</span>
        {% else %}
          <span class="status-fail">OFFLINE</span>
        {% endif %}
        | Socket base:
        {{ socket_client_config.base or "(not configured)" }}
      </p>
    </header>
    <main>
      <section>
        <h2>DocumentViewer</h2>
        {% if doc_viewer_url %}
          <p class="helper-text">URL: {{ doc_viewer_url }}</p>
          <iframe src="{{ doc_viewer_url }}" title="Document Viewer"></iframe>
        {% else %}
          <p class="status-fail">DOCUMENT_VIEWER_URL が未設定です。</p>
        {% endif %}
      </section>

      <section>
        <h2>工具管理 (Tool Management)</h2>
        <p>{{ toolmgmt_status }}</p>
        <p class="helper-text">
          APIトークン:
          {% if api_token_present %}
            {{ api_token_preview or "(mask省略)" }}（Station: {{ api_station_id or "-" }}）
          {% else %}
            <span class="status-fail">未設定です。`window_a/config/window-a.env` の `WINDOW_A_API_TOKEN_HEADER` と token 発行を確認してください。</span>
          {% endif %}
        </p>
        <p class="status-fail hidden" data-token-warning>APIトークンが未設定です。</p>
        <p class="helper-text" data-overview-updated>
          最終更新: {{ toolmgmt_view.fetched_at or "未取得" }}
        </p>
        {% if toolmgmt_view.error %}
          <p class="status-fail">{{ toolmgmt_view.error }}</p>
        {% endif %}
        <div
          class="toolmgmt-action-panel"
          data-toolmgmt-actions
          data-api-token="{{ api_token_value }}"
          data-api-header="{{ api_token_header }}"
          data-overview-url="{{ url_for('api_toolmgmt_overview') }}"
        >
          <h3>同期ファイル</h3>
          <table>
            <thead>
              <tr>
                <th>ファイル</th>
                <th>説明</th>
                <th>件数</th>
                <th>更新日時</th>
              </tr>
            </thead>
            <tbody data-master-files-body>
              {% for file in toolmgmt_view.master_files %}
                <tr>
                  <td>{{ file.filename }}</td>
                  <td>{{ file.label }}</td>
                  <td>
                    {% if file.exists %}
                      {{ file.row_count }}
                    {% else %}
                      <span class="status-fail">未同期</span>
                    {% endif %}
                  </td>
                  <td>{{ file.updated_at or "-" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <h3>貸出中リスト</h3>
          <table
            data-open-loans-table
            class="{% if not toolmgmt_view.open_loans %}hidden{% endif %}"
          >
            <thead>
              <tr>
                <th>ID</th>
                <th>工具名</th>
                <th>借用者</th>
                <th>貸出日時</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody data-open-loans-body>
              {% for loan in toolmgmt_view.open_loans %}
                <tr>
                  <td>{{ loan.id }}</td>
                  <td>{{ loan.tool_name }}</td>
                  <td>{{ loan.borrower_name }}</td>
                  <td>{{ loan.loaned_at }}</td>
                  <td>
                    <button
                      type="button"
                      data-action="manual-return"
                      data-loan-id="{{ loan.id }}"
                    >
                      手動返却
                    </button>
                    <button
                      type="button"
                      data-action="delete-loan"
                      data-loan-id="{{ loan.id }}"
                    >
                      削除
                    </button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          <p
            data-open-loans-empty
            class="helper-text"
            {% if toolmgmt_view.open_loans %}style="display:none;"{% endif %}
          >
            貸出中の工具はありません。
          </p>

          <h3>直近の貸出 / 返却履歴</h3>
          <table
            data-history-table
            class="{% if not toolmgmt_view.history %}hidden{% endif %}"
          >
            <thead>
              <tr>
                <th>区分</th>
                <th>工具</th>
                <th>利用者</th>
                <th>貸出</th>
                <th>返却</th>
              </tr>
            </thead>
            <tbody data-history-body>
              {% for item in toolmgmt_view.history %}
                <tr>
                  <td>{{ item.action }}</td>
                  <td>{{ item.tool_name }}</td>
                  <td>{{ item.borrower_name }}</td>
                  <td>{{ item.loaned_at }}</td>
                  <td>{{ item.returned_at or "-" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          <p
            data-history-empty
            class="helper-text"
            {% if toolmgmt_view.history %}style="display:none;"{% endif %}
          >
            最近の履歴データはありません。
          </p>

          <p data-toolmgmt-result class="helper-text">
            操作結果はここに表示され、自動でリストが更新されます。
          </p>
          <div class="toolmgmt-log" data-toolmgmt-log>
            <strong>操作ログ</strong>
            <ul></ul>
          </div>
        </div>

        <div
          class="nfc-panel"
          data-nfc-actions
          data-api-token="{{ api_token_value }}"
          data-api-header="{{ api_token_header }}"
        >
          <h3>NFC スキャン（Pi4 リーダー）</h3>
          <p class="helper-text">
            利用者タグ → 工具タグ の順に読み取り、UID を確認します。Pi5 への貸出送信は今後のタスクです。
          </p>
          <p class="status-ok" data-nfc-status>準備完了</p>
          <button type="button" data-nfc-scan class="primary">NFC でスキャン</button>
          <div class="nfc-sequence">
            <strong>読み取り履歴</strong>
            <ul data-nfc-log></ul>
          </div>
        </div>
      </section>

      <section>
        <h2>最新の所在情報 (part_locations)</h2>
        {% if part_locations %}
          <table>
            <thead>
              <tr>
                <th>注文コード</th>
                <th>棚</th>
                <th>端末</th>
                <th>更新日時</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in part_locations %}
                <tr>
                  <td>{{ entry.order_code }}</td>
                  <td>{{ entry.location_code }}</td>
                  <td>{{ entry.device_id }}</td>
                  <td>{{ entry.updated_at }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="helper-text">表示できる所在情報がありません。</p>
        {% endif %}
      </section>

      <section>
        <h2>物流依頼 (logistics jobs)</h2>
        {% if logistics_jobs %}
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>部品</th>
                <th>From</th>
                <th>To</th>
                <th>Status</th>
                <th>更新</th>
              </tr>
            </thead>
            <tbody>
              {% for job in logistics_jobs %}
                <tr>
                  <td>{{ job.job_id }}</td>
                  <td>{{ job.part_code }}</td>
                  <td>{{ job.from_location }}</td>
                  <td>{{ job.to_location }}</td>
                  <td>{{ job.status }}</td>
                  <td>{{ job.updated_at }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="helper-text">取得可能な物流ジョブがありません。Pi5 の `/api/logistics/jobs` が未実装の場合はこのまま空欄になります。</p>
        {% endif %}
      </section>

      <section>
        <h2>生産計画 / 標準工数 (RaspberryPiServer)</h2>
        {% if production_view.plan_error %}
          <p class="status-fail">{{ production_view.plan_error }}</p>
        {% endif %}
        {% if production_view.entries %}
          <table>
            <thead>
              <tr>
                {% for key in production_view.entries[0].keys() %}
                  <th>{{ key }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in production_view.entries %}
                <tr>
                  {% for value in row.values() %}
                    <td>{{ value }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="helper-text">生産計画は未取得です。</p>
        {% endif %}
      </section>

      <section>
        <h2>ステーション設定</h2>
        <pre>{{ station_config | tojson(indent=2) }}</pre>
      </section>
    </main>
    <script>
      const socketClientConfig = {{ socket_client_config | tojson }};
      console.log("Socket client config:", socketClientConfig);
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const panel = document.querySelector('[data-toolmgmt-actions]');
        if (!panel) return;
        const token = panel.dataset.apiToken;
        const headerName = panel.dataset.apiHeader || 'X-API-Token';
        const overviewUrl = panel.dataset.overviewUrl || '';
        const statusEl = panel.querySelector('[data-toolmgmt-result]');
        const tokenWarning = panel.querySelector('[data-token-warning]');
        const logList = panel.querySelector('[data-toolmgmt-log] ul');
        const refreshDelayMs = 2000;
        let refreshTimer = null;

        const masterBody = panel.querySelector('[data-master-files-body]');
        const openTable = panel.querySelector('[data-open-loans-table]');
        const openBody = panel.querySelector('[data-open-loans-body]');
        const openEmpty = panel.querySelector('[data-open-loans-empty]');
        const historyTable = panel.querySelector('[data-history-table]');
        const historyBody = panel.querySelector('[data-history-body]');
        const historyEmpty = panel.querySelector('[data-history-empty]');
        const overviewUpdated = panel.querySelector('[data-overview-updated]');

        const logMessage = (message) => {
          if (!logList) return;
          const li = document.createElement('li');
          const time = new Date().toLocaleTimeString('ja-JP', { hour12: false });
          li.textContent = `[${time}] ${message}`;
          logList.prepend(li);
          while (logList.children.length > 20) {
            logList.removeChild(logList.lastChild);
          }
        };

        const toggleTokenWarning = (message, show) => {
          if (!tokenWarning) return;
          if (show) {
            tokenWarning.textContent = message;
            tokenWarning.classList.remove('hidden');
          } else {
            tokenWarning.classList.add('hidden');
          }
        };

        const getActionButtons = () => panel.querySelectorAll('button[data-loan-id][data-action]');

        const setResult = (message, isError = false) => {
          if (statusEl) {
            statusEl.textContent = message;
            statusEl.classList.toggle('status-fail', isError);
            statusEl.classList.toggle('status-ok', !isError);
          }
          logMessage(message);
        };

        const formatDate = (value) => {
          if (!value) {
            return '-';
          }
          return value;
        };

        const formatTimestamp = (value) => {
          if (!value) {
            return '未取得';
          }
          const asDate = new Date(value);
          if (Number.isNaN(asDate.getTime())) {
            return value;
          }
          return asDate.toLocaleString('ja-JP');
        };

        const renderMasterFiles = (entries = []) => {
          if (!masterBody) return;
          masterBody.innerHTML = entries
            .map(
              (entry) => `
                <tr>
                  <td>${entry.filename || ''}</td>
                  <td>${entry.label || ''}</td>
                  <td>${entry.exists ? entry.row_count ?? '' : '<span class="status-fail">未同期</span>'}</td>
                  <td>${entry.updated_at || '-'}</td>
                </tr>
              `,
            )
            .join('');
        };

        const renderOpenLoans = (loans = []) => {
          if (openBody) {
            openBody.innerHTML = loans
              .map(
                (loan) => `
                  <tr>
                    <td>${loan.id ?? ''}</td>
                    <td>${loan.tool_name ?? ''}</td>
                    <td>${loan.borrower_name ?? ''}</td>
                    <td>${formatDate(loan.loaned_at)}</td>
                    <td>
                      <button type="button" data-action="manual-return" data-loan-id="${loan.id ?? ''}">手動返却</button>
                      <button type="button" data-action="delete-loan" data-loan-id="${loan.id ?? ''}">削除</button>
                    </td>
                  </tr>
                `,
              )
              .join('');
          }
          if (openTable) {
            openTable.classList.toggle('hidden', loans.length === 0);
          }
          if (openEmpty) {
            openEmpty.style.display = loans.length === 0 ? 'block' : 'none';
          }
        };

        const renderHistory = (history = []) => {
          if (historyBody) {
            historyBody.innerHTML = history
              .map(
                (item) => `
                  <tr>
                    <td>${item.action ?? ''}</td>
                    <td>${item.tool_name ?? ''}</td>
                    <td>${item.borrower_name ?? ''}</td>
                    <td>${formatDate(item.loaned_at)}</td>
                    <td>${formatDate(item.returned_at)}</td>
                  </tr>
                `,
              )
              .join('');
          }
          if (historyTable) {
            historyTable.classList.toggle('hidden', history.length === 0);
          }
          if (historyEmpty) {
            historyEmpty.style.display = history.length === 0 ? 'block' : 'none';
          }
        };

        const refreshOverview = async () => {
          if (!overviewUrl) {
            setResult('工具管理の更新エンドポイントが未設定です。', true);
            return;
          }
          try {
            const response = await fetch(overviewUrl);
            const data = await response.json();
            if (!response.ok) {
              throw new Error((data && data.error) || response.statusText || 'unknown error');
            }
            renderMasterFiles(data.master_files || []);
            renderOpenLoans(data.open_loans || []);
            renderHistory(data.history || []);
            if (overviewUpdated) {
              overviewUpdated.textContent = `最終更新: ${formatTimestamp(data.fetched_at)}`;
            }
            bindActionButtons();
            setResult('工具管理データを更新しました。', false);
          } catch (error) {
            setResult(`概要更新に失敗しました: ${error.message || error}`, true);
          }
        };

        const actionLabels = {
          'manual-return': '手動返却',
          'delete-loan': '貸出削除',
        };

        const handleLoanAction = async (event) => {
          const btn = event.currentTarget;
          const loanId = btn.dataset.loanId;
          const action = btn.dataset.action;
          if (!loanId || !action) {
            return;
          }

          const endpoint =
            action === 'manual-return'
              ? `/api/loans/${loanId}/manual_return`
              : `/api/loans/${loanId}`;
          const method = action === 'manual-return' ? 'POST' : 'DELETE';
          const label = actionLabels[action] || '操作';

          btn.disabled = true;
          setResult(`${label}を実行中...`, false);

          try {
            const response = await fetch(endpoint, {
              method,
              headers: {
                'Content-Type': 'application/json',
                [headerName]: token,
              },
              body: method === 'POST' ? '{}' : undefined,
            });
            const data = await response.json().catch(() => ({}));
            if (!response.ok) {
              const err = (data && data.error) || response.statusText || 'unknown error';
              throw new Error(err);
            }
            setResult(`${label}に成功しました (loan_id=${loanId})。まもなく一覧を更新します。`, false);
            if (refreshTimer) {
              clearTimeout(refreshTimer);
            }
            refreshTimer = setTimeout(() => {
              refreshOverview();
            }, refreshDelayMs);
          } catch (error) {
            setResult(`エラー: ${error.message || error}`, true);
          } finally {
            btn.disabled = false;
          }
        };

        const bindActionButtons = () => {
          const buttons = getActionButtons();
          buttons.forEach((btn) => {
            btn.removeEventListener('click', handleLoanAction);
            btn.addEventListener('click', handleLoanAction);
          });
          return buttons;
        };

        const initialButtons = bindActionButtons();

        if (!token) {
          initialButtons.forEach((btn) => {
            btn.disabled = true;
          });
          toggleTokenWarning('APIトークンが未設定のため、貸出操作は無効です。', true);
          setResult('APIトークンが未設定のため、貸出操作は無効化されています。', true);
          return;
        }

        toggleTokenWarning('', false);

        if (overviewUrl) {
          refreshOverview();
        } else {
          setResult('工具管理の更新エンドポイントが未設定です。', true);
        }

        const nfcPanel = document.querySelector('[data-nfc-actions]');
        if (nfcPanel && token) {
          const nfcStatus = nfcPanel.querySelector('[data-nfc-status]');
          const nfcButton = nfcPanel.querySelector('[data-nfc-scan]');
          const nfcLog = nfcPanel.querySelector('[data-nfc-log]');
          const nfcState = { borrower: null };

          const appendNfcLog = (message, success = true) => {
            if (!nfcLog) return;
            const li = document.createElement('li');
            const time = new Date().toLocaleTimeString('ja-JP', { hour12: false });
            li.textContent = `[${time}] ${message}`;
            li.classList.toggle('status-fail', !success);
            nfcLog.prepend(li);
            while (nfcLog.children.length > 10) {
              nfcLog.removeChild(nfcLog.lastChild);
            }
          };

          const updateNfcStatus = (message, isError = false) => {
            if (!nfcStatus) return;
            nfcStatus.textContent = message;
            nfcStatus.classList.toggle('status-fail', isError);
            nfcStatus.classList.toggle('status-ok', !isError);
          };

          const performLoanCreate = async (borrowerUid, toolUid) => {
            try {
              const response = await fetch('/api/loans', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  [headerName]: token,
                },
                body: JSON.stringify({
                  borrower_uid: borrowerUid,
                  tool_uid: toolUid,
                }),
              });
              const data = await response.json().catch(() => ({}));
              if (!response.ok) {
                const err = (data && data.error) || response.statusText || 'unknown';
                throw new Error(err);
              }
              appendNfcLog(`貸出登録: ${borrowerUid} -> ${toolUid} (loan_id=${data.loan_id})`, true);
              updateNfcStatus('貸出登録に成功しました', false);
              setResult('NFC から貸出を登録しました。', false);
              refreshOverview();
            } catch (error) {
              appendNfcLog(`貸出登録エラー: ${error.message || error}`, false);
              updateNfcStatus('貸出登録に失敗しました', true);
              setResult(`エラー: ${error.message || error}`, true);
            }
          };

          const handleScan = async () => {
            try {
              updateNfcStatus('スキャン待機中...', false);
              nfcButton.disabled = true;
              const response = await fetch('/api/scan_tag', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  [headerName]: token,
                },
              });
              const data = await response.json().catch(() => ({}));
              if (!response.ok || (data && data.status !== 'success')) {
                const err = (data && data.status) || response.statusText || 'unknown';
                throw new Error(err);
              }
              if (!nfcState.borrower) {
                nfcState.borrower = data.uid;
                appendNfcLog(`利用者 UID: ${data.uid}`, true);
                updateNfcStatus('利用者タグを読み取りました。次に工具タグをかざしてください。', false);
              } else {
                appendNfcLog(`工具 UID: ${data.uid}`, true);
                updateNfcStatus('工具タグを読み取りました。貸出登録中...', false);
                await performLoanCreate(nfcState.borrower, data.uid);
                nfcState.borrower = null;
              }
            } catch (error) {
              appendNfcLog(`NFC エラー: ${error.message || error}`, false);
              updateNfcStatus('NFC 読み取りに失敗しました', true);
            } finally {
              nfcButton.disabled = false;
            }
          };

          nfcButton.addEventListener('click', handleScan);
        }
      });
    </script>
  </body>
</html>
