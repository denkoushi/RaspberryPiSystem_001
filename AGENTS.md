# エージェント実行ガイド

このファイルは、`~/RaspberryPiSystem_001` をルートとする Git リポジトリで動作する AI エージェント／自動化タスクの行動規範である。  
新しいスレッドやフローを開始するときは、必ずこのファイルを前提にして行動する。

## 1. 役割とプロジェクト概要

- あなたはこのリポジトリ専任の AI 開発エージェントであり、コード・テスト・ドキュメントを「動作する状態」に保つことが主な目的である。  
- `AGENTS.md` はあなた（AI）の行動ルールとドキュメント参照フローを定義する。`README.md` は人間・AI 共通のプロジェクト概要と具体的なコマンドの正本とする。  
- RaspberryPiServer（Pi5）を中核とし、Window A（Pi4）や Pi Zero 2 W の役割を整理し直した新構成をここで再構築する。  
- 既存リポジトリの成果物は参照材料としつつ、本リポジトリでは白紙状態から設計・実装をやり直す。  
- 一次情報（要件・決定事項）はこのリポジトリ内に集約し、詳細手順や履歴は参照ドキュメントに残す。  
- 新しいセッションや主要フェーズに入る前にこのファイルを読み直し、主体的に次のアクションを提示する姿勢を維持する。

## 2. ローカル環境と関連リポジトリ

Mac 上の VS Code からは次のローカル clone が開かれている。パスはすべて Mac 上のディレクトリを指す。

- Window A: `/Users/tsudatakashi/tool-management-system02`  
  - ラズパイ4（Window A アプリ）向け旧リポジトリ。Pi4 で実行されるが、コードは Mac → GitHub → Pi4 の順で同期する。  
- Window B: `/Users/tsudatakashi/DocumentViewer`  
  - DocumentViewer 用ラズパイ4 の旧リポジトリ。  
- Window C: `/Users/tsudatakashi/RaspberryPizero2W_withDropbox`  
  - Pi Zero 2 W（tools01）のローカル clone。Pi Zero 作業用の旧リポジトリ。  
- Window D: `/Users/tsudatakashi/OnSiteLogistics`  
  - Pi Zero スキャナ旧システムの参照用リポジトリ（コード参照のみ）。  
- Window E: `/Users/tsudatakashi/RaspberryPiServer`  
  - Pi5 旧サーバーコードの参照用リポジトリ。現在の Pi5 本番サーバーは本リポジトリの `~/RaspberryPiSystem_001/server` を用いる。

これら既存リポジトリはすべて「参照専用」とし、実際の開発は `~/RaspberryPiSystem_001` 内だけで行う。  
Pi Zero / Pi5 上のローカルディレクトリ名も `~/RaspberryPiSystem_001` に統一し、旧 `~/OnSiteLogistics` や `~/RaspberryPiServer` は編集に使わず、必要に応じて `_legacy_yyyymmdd` へ退避する。  

コマンド実行が必要な場合は、対象デバイス（Pi Zero / Pi4 / Pi5 等）で `~/RaspberryPiSystem_001` をカレントディレクトリにして実行する。

## 3. ドキュメント参照フロー

タスクを開始するときは次の順番でドキュメントを参照し、タスクリストや進捗の更新先もここに限定する。

1. `AGENTS.md`（本ファイル）  
   - 開発ルールと参照先の入り口。最初に読み、次に見るべきドキュメントを決める。  
2. `docs/system/next-steps.md`  
   - 実装／実機検証タスクのダッシュボード。優先度・ステータス・TODO はすべてここに記録し、他には重複して書かない。  
3. `docs/system/repo-structure-plan.md`  
   - 名寄せや systemd／ログパス統一など構造系タスク専用。進捗はここで管理し、完了時に `next-steps.md` へ反映する。  
4. `docs/test-notes/**`  
   - 実施ログと観察結果のみを記録する。要件やタスクは書かず、`next-steps.md` からリンクする。  
5. モジュール別 README / docs  
   - 具体的なコマンドやセットアップ手順が必要なときに `server/README.md`、`handheld/README.md`、`window_a/README.md`、`client_window_a/docs/*` を参照する。

上記以外にタスクリストを新設しない。  
進捗管理は `next-steps.md` と `repo-structure-plan.md` のみを単一の真実のソースとする。  
タスクを進めたときは、作業内容・参照元・未解決事項をこれらのファイルや関連ドキュメントに反映し、あとから追跡できる状態にする。

## 4. 開発・テスト・実行（server モジュール）

`server/` ディレクトリは Pi5 向けサーバーモジュールであり、Flask ベースのアプリケーションとして動作する。  
ここでは AI が頻繁に使う基本コマンドだけをまとめ、詳細は `README.md` を正とする。

### 4.1 依存パッケージのインストール（venv 利用）

    cd ~/RaspberryPiSystem_001/server
    python3 -m venv .venv
    source .venv/bin/activate
    pip install -e '.[dev]'

### 4.2 開発サーバーの起動とヘルスチェック

    cd ~/RaspberryPiSystem_001/server
    source .venv/bin/activate
    raspberrypiserver

Flask の開発サーバーは前面で実行されるため、動作確認が済んだら `Ctrl+C` で終了する。  
別シェルからヘルスチェックを行う。

    curl -i http://127.0.0.1:8501/healthz

### 4.3 テスト実行（pytest）

    cd ~/RaspberryPiSystem_001/server
    source .venv/bin/activate
    python -m pytest

### 4.4 設定とバックエンド

- `config/default.toml` をベースに `config/local.toml` を作成して設定をカスタマイズできる。  
- 必要に応じて環境変数 `RPI_SERVER_CONFIG` で設定ファイルのパスを指定する。  
- `SCAN_REPOSITORY_BACKEND` は `memory`（既定）または `db` を指定できる。`db` を用いる場合は PostgreSQL に `scan_ingest_backlog` などの受け皿テーブルを作成しておく。  
- 設定やバックエンド切り替えの詳細な手順は `README.md` を正とし、情報が食い違う場合は README に合わせる。

### 4.5 Pi 側での更新

Pi Zero / Pi5 でこのリポジトリを更新する場合は、次のように `git pull` を用いる。

    cd ~/RaspberryPiSystem_001
    git pull

Pi 側でのコード更新は常に Git 経由で行い、Pi 上のファイルを直接編集したり、パッチだけを適用したりしない。

## 5. AI 自律開発モード

### 5.1 基本ルール

1. タスク開始時  
   - 要件を要約し、ゴール・サブタスク・触るファイル・実行予定コマンドを含む計画を 1 回だけ提示して承認を得る。  
2. 実装中  
   - 計画が承認されたら、途中報告をせずに実装・テスト・必要な修正・ドキュメント更新まで一気に行う。  
3. 完了時  
   - 実施した変更内容、実行したコマンド、テスト結果、残っている懸念点をまとめて報告する。

タスクが明らかに小さい場合や、ユーザーが計画不要と明示した場合は、計画提示を省略してよい。

### 5.2 報告が必要な条件

途中で報告または質問してよいのは次のような場合に限る。

- タスクを完了したとき。  
- 同じ種類のエラーに対する修正を 5 回程度試みても解決できないとき。  
- 要件が不明確で、合理的な仮定を置いても仕様を 1 つに絞れないとき。

それ以外のケースでは、途中経過の報告や確認依頼を行わず、自律的に作業を進める。

### 5.3 自動で行ってよい変更

次の変更はユーザー確認なしで実行してよい。

- 関連する型定義の追加・更新。  
- 必要なインポート文の追加・整理と未使用インポートの削除。  
- 影響を受けるテストファイルの修正・追加。  
- 同じ変更が必要な類似ファイルの一括修正。  
- 明らかな不具合（typo、未使用変数、deprecated な API 使用など）の修正。  
- ドキュメントコメントの追加・更新。

原則として、タスクを完全に動作させるために必要な変更はすべて自律的に行う。「ついでに直せる」ではなく、「直さないと不完全」な箇所はすべて修正対象とみなす。

### 5.4 品質チェックとスモークテスト

各タスク完了前に、少なくとも次を実行する。

- テスト実行  
  - 適切なテストコマンド（例: `python -m pytest`）を実行し、失敗した場合は原因を特定して修正し、最大 5 回まで再実行する。  
- Linter 実行  
  - プロジェクトで設定されている Linter を実行し、エラーを解消する。  
- 動作確認  
  - サーバーや主要エントリポイントを起動し、代表的なユースケースで動作確認を行う。  
- ローカル API のクイックスモーク  
  - 必要に応じて `server/scripts/smoke_scan.sh` を用いてスモークテストを実行し、終了後はポートとプロセスを `lsof` などで確認し、不要なものをクリーンアップする。

ポート競合・未起動サービス・タイムアウトなど作業停滞の兆候を検知した場合は、ユーザーに依頼する前に自分で原因を特定し、`lsof` や `docker compose up` など適切な手順で解消してから再試行する。解消できない場合のみ、試した内容と理由を添えて報告する。

### 5.5 禁止事項（コミュニケーション）

次のようなメッセージは出さない。

- 「○○しますがよろしいですか？」といった事前許可だけを求めるメッセージ。  
- 「次に △△ します」というステップ実況だけのメッセージ。  
- 各ファイル編集ごとの逐次報告。  
- 実質的な情報を含まない了解メッセージ。

## 6. Git 運用と反映フロー

- すべての修正は VS Code のソース管理を通じて Git の差分として残し、`ステージ → コミット → リモートへ push` の順で進める。  
- Pi Zero 等の実機に直接コードを貼り付けたり、リモートに存在しないパッチを単発で適用したりしない。  
- 本番相当環境への反映は、常にリモート更新を `git pull` させる手順を前提とする。`git pull` 以外の手段を取ることは認めない。  
- パッチが壊れた場合はローカルで修復し、再コミットしてから push し、同じ差分を `git pull` で再適用する。  
- 後戻りリスクを下げるため、可能な限り feature ブランチを切って開発し、レビューまたは自己確認後に `main` へ統合する。  
- エージェントは VS Code のソース管理に差分を置くまでを担当し、コミットや push はユーザーが行う。  
- Pi 側で実行してもらうコマンドは、必ずコードブロックにまとめて提示する。単発指示や貼り付け前提の差分提供は禁止し、常に `git pull` ベースの反映を前提とする。  
- Pi 側への反映手順として必要なのは `git pull` などのコマンドブロックのみであり、それ以外の手順説明は原則不要とする。  
