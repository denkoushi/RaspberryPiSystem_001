# エージェント実行ガイド

このリポジトリでエージェントや自動化タスクを起動する際の前提と手順をまとめる。新しいスレッドやフローを開始するときは必ず本ファイルを参照する。

## プロジェクト構成
- Window A: `/Users/tsudatakashi/tool-management-system02`
- Window B: `/Users/tsudatakashi/DocumentViewer`
- Window C: `/Users/tsudatakashi/RaspberryPizero2W_withDropbox`
- Window D: `/Users/tsudatakashi/OnSiteLogistics`
- Window E: `/Users/tsudatakashi/RaspberryPiServer`

各ウィンドウ（リポジトリ）のパスは **Mac 上で VS Code が参照しているローカル clone** を指す。実機で稼働しているホストとは次の対応になる。
- Window A (`tool-management-system02`) … ラズパイ4（Window A アプリ）向け旧リポジトリ。Pi4 で実行されるが、コードは Mac→GitHub→Pi4 の順で同期する。
- Window B (`DocumentViewer`) … DocumentViewer 用ラズパイ4 の旧リポジトリ。
- Window C (`RaspberryPizero2W_withDropbox`) … Pi Zero 2 W のローカル clone（tools01）。Pi Zero の作業用。
- Window D (`OnSiteLogistics`) … Pi Zero スキャナ旧システムの参照用リポジトリ（コード参照のみ）。
- Window E (`RaspberryPiServer`) … Pi5 旧サーバーコードの参照用リポジトリ。Pi5 の本番サーバーは本リポジトリ（`~/RaspberryPiSystem_001/server`）を用いる。

コマンド実行が必要な場合は、対象デバイス（Pi Zero/Pi4/Pi5 等）で行う。各ウィンドウの情報は独立して扱い、参照する際も原則ユーザー確認は不要。

## ドキュメント参照フロー
タスクを開始するときは必ず以下の順番で参照し、進捗の更新も指定されたファイルに限定する。

1. **AGENTS.md（本ファイル）**  
   - 開発ルールと参照先の入り口。ここを読み、次に参照するドキュメントを決める。
2. **`docs/system/next-steps.md`**  
   - 実装／実機検証タスクのダッシュボード。優先度・ステータス・TODO はすべてここに記録し、他では重複させない。
3. **`docs/system/repo-structure-plan.md`**  
   - 名寄せ、systemd/ログパス統一など構造系タスク専用。進捗はこのファイルで管理し、完了時に `next-steps.md` へ反映する。
4. **`docs/test-notes/**`**  
   - 実施ログと観察結果のみを記録。要件やタスクは書かず、`next-steps.md` にリンクする。
5. **モジュール README / docs** (`server/README.md`, `handheld/README.md`, `window_a/README.md`, `client_window_a/docs/*`)  
   - 具体的なコマンドやセットアップ手順が必要なときに参照する。

> 上記以外にタスクリストを作らない。進捗の更新漏れ防止のため、タスクは `next-steps.md` と `repo-structure-plan.md` のみで管理する。

## 方針
1. 一次情報（要件・決定事項）は本リポジトリ内で管理する。詳細手順や過去履歴は参照先ドキュメントにまとめる。
2. 既存の各リポジトリは途中までの試作が残っているが、本リポジトリでは白紙から再開発する。必要に応じて参照のみ行う。
3. エージェントは作業内容と参照元を明記し、進捗や未解決事項を README などに反映させる。
4. 新しいセッションや主要フェーズに入る前、エージェントは必ず本ファイルを読み返し、指針（主体的に判断し次のアクションを提示する等）を遵守する。
5. 作業が停滞する兆候（ポート競合・未起動サービス・待機タイムアウトなど）を検知した場合は、ユーザーへ依頼する前にエージェント自身で原因を特定し、`lsof` や `docker compose up` など適切な手順で解消してから再試行する。解消不可な場合のみ、理由と共に報告する。ローカル API のクイックスモークは `server/scripts/smoke_scan.sh` を用いて実行し、実行後はポートとプロセスを必ずクリーンアップする。

## AI自律開発モード

### 基本ルール
1. **タスク開始時**: 計画を1回だけ提示して承認を得る
2. **実装中**: 報告せず完了まで作業を続ける
3. **完了時**: 結果のみ報告

### 作業フロー

    受領 → 計画提示 → [承認] → 実装+テスト+修正 → 完了報告
             ↑                      ↑
          確認求める              報告しない

### 報告する条件
- タスク完了時
- エラーを5回修正しても解決しない時
- 要件が不明で推測不可能な時

上記以外は報告禁止。

### 開発範囲の判断
以下は**確認不要で自動実行**:
- 関連する型定義の更新
- インポート文の追加・整理
- 影響を受けるテストファイルの修正
- 同じ変更が必要な類似ファイルの一括修正
- 明らかな不具合（typo、未使用変数、deprecatedなAPI）の修正
- ドキュメントコメントの追加・更新

**原則**: タスクを完全に動作させるために必要なことは全て実行する。「ついでに直せる」ではなく「直さないと不完全」なものは全て対象。

### 必須実行項目
各タスク完了前に必ず実行:
- テスト実行（失敗なら修正して再実行、5回まで）
- Linter実行（エラーなら修正）
- 動作確認

### 禁止事項
- 「○○しますがよろしいですか?」
- 「次に△△します」
- 各ファイル編集ごとの報告
- 進捗の逐次報告

### Git / 反映フローの厳守
- すべての修正は **必ず VS Code のソース管理（= Git リポジトリ）に差分を置く → コミット → リモートへ push** の順で進める。Pi Zero 等の実機に直接コードを貼り付けたり、リモートに存在しないパッチを単発で適用させる行為は禁止。
- 実機へ反映させる手順は「リモート更新を pull させる」ことを前提とし、`git pull` 以外の手段を取るのは最終手段でも認めない。パッチが壊れた場合はローカルで修復 → 再コミット → push し、同じ差分を再度提供する。
- 後戻りリスクを下げるため、可能な限り feature ブランチを切って開発し、レビュー or 自己確認後に main へ統合する。
- Mac / Pi Zero / Pi5 のローカルディレクトリ名はすべて `~/RaspberryPiSystem_001` に統一し、旧 `~/OnSiteLogistics` や `~/RaspberryPiServer` を編集に使わない（参照が必要な場合のみ `_legacy_yyyymmdd` に退避）。
- Pi Zero / Pi5 で実行してもらうコマンドは、必ずコードブロックにまとめて提示する。単発指示や貼り付け前提の差分提供は禁止し、常に `git pull` ベースの反映を前提とする。
- エージェントは VS Code のソース管理に差分を置くだけで良く、コミットや push はユーザーが行う。Pi 側へ反映するコマンドのみ（`git pull` を含むコードブロック）を提示し、それ以外の手順開示は不要。
